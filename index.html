<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Crea Mini DB</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>
    <div class="container">
        <div class="editor-container">
            
            <div class="hero">
                <h1>üìö Crea Mini DB</h1>
                <h2>¬°Crea tu propia base de datos en tu navegador!</h2>
                <div class="form-section">
                    <input type="text" id="searchInput" placeholder="Buscar por t√≠tulo, contenido o etiquetas...">
                </div>
            </div>
            
            <div class="form-section">
                <div class="entries-grid" id="entriesList"></div>

                <div class="export-section">
                    <button onclick="downloadJSON()" class="action-button">‚¨áÔ∏è Exportar JSON</button>
                    <pre id="jsonOutput"></pre>
                </div>
            </div>

            <div class="form-section info-section">
                <p>üìù Esta mini base de datos se almacena localmente en tu navegador y persistir√° indefinidamente hasta que:</p>
                <ul>
                    <li>Borres los datos del navegador</li>
                    <li>Usas el modo inc√≥gnito (se borrar√°n al cerrar la ventana)</li>
                    <li>Se alcance el l√≠mite de almacenamiento (5-10 MB)</li>
                </ul>
                <p>üíæ Usa el bot√≥n "Exportar JSON" para hacer una copia de seguridad de tus datos.</p>
            </div>
        </div>
    </div>

    <button onclick="openCreateModal()" class="create-entry-btn">‚ú® Crear Entrada</button>

    <!-- Modal de Creaci√≥n/Edici√≥n -->
    <div class="modal-overlay" id="editorModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">‚ú® Crear Nueva Entrada</h2>
                <button onclick="closeModal()" class="modal-close" title="Cerrar">√ó</button>
            </div>
            <div class="modal-body">
                <form class="editor-form" onsubmit="return false;">
                    <div class="input-group">
                        <input type="text" id="entryTitle" placeholder="T√≠tulo de la entrada">
                    </div>

                    <div class="tag-system">
                        <div class="input-group">
                            <div class="tags-input">
                                <div id="tagsList"></div>
                                <input type="text" 
                                       id="tagInput" 
                                       placeholder="Escribe una etiqueta y presiona Enter o coma" 
                                       onkeydown="if(event.key === 'Enter' || event.key === ',') { event.preventDefault(); addTag(this.value); this.value = ''; }"
                                />
                            </div>
                        </div>
                    </div>

                    <div class="editor-toolbar">
                        <button onclick="formatText('bold')" title="Negrita"><strong>B</strong></button>
                        <button onclick="formatText('italic')" title="Cursiva"><em>I</em></button>
                        <button onclick="formatText('underline')" title="Subrayado"><u>U</u></button>
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        <button onclick="document.getElementById('imageUpload').click()" title="Subir imagen">üì∑ Imagen</button>
                    </div>

                    <div 
                        class="editor-content"
                        contenteditable="true"
                        id="richTextArea"
                        placeholder="‚úçÔ∏è Escribe tu contenido aqu√≠..."
                    ></div>
                    <div class="modal-info">
                        <small class="date-info"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="action-button secondary">‚ùå Cancelar</button>
                <button onclick="saveEntry()" class="action-button">üíæ Guardar Entrada</button>
            </div>
        </div>
    </div>

<script>
// Polyfills para navegadores antiguos
if (!Array.from) {
    Array.from = (function () {
        var toStr = Object.prototype.toString;
        var isCallable = function (fn) {
            return typeof fn === 'function' || toStr.call(fn) === '[object Function]';
        };
        var toInteger = function (value) {
            var number = Number(value);
            return isNaN(number) ? 0 : number;
        };
        var maxSafeInteger = Math.pow(2, 53) - 1;
        var toLength = function (value) {
            var len = toInteger(value);
            return Math.min(Math.max(len, 0), maxSafeInteger);
        };

        return function from(arrayLike) {
            var C = this;
            var items = Object(arrayLike);
            if (arrayLike == null) {
                throw new TypeError('Array.from requires an array-like object - not null or undefined');
            }
            var mapFn = arguments.length > 1 ? arguments[1] : void undefined;
            var T;
            if (typeof mapFn !== 'undefined') {
                if (!isCallable(mapFn)) {
                    throw new TypeError('Array.from: when provided, the second argument must be a function');
                }
                if (arguments.length > 2) {
                    T = arguments[2];
                }
            }
            var len = toLength(items.length);
            var A = isCallable(C) ? Object(new C(len)) : new Array(len);
            var k = 0;
            var kValue;
            while (k < len) {
                kValue = items[k];
                if (mapFn) {
                    A[k] = typeof T === 'undefined' ? mapFn(kValue, k) : mapFn.call(T, kValue, k);
                } else {
                    A[k] = kValue;
                }
                k += 1;
            }
            A.length = len;
            return A;
        };
    }());
}

// Polyfill para Element.matches
if (!Element.prototype.matches) {
    Element.prototype.matches = 
        Element.prototype.matchesSelector || 
        Element.prototype.mozMatchesSelector ||
        Element.prototype.msMatchesSelector || 
        Element.prototype.oMatchesSelector || 
        Element.prototype.webkitMatchesSelector ||
        function(s) {
            var matches = (this.document || this.ownerDocument).querySelectorAll(s),
                i = matches.length;
            while (--i >= 0 && matches.item(i) !== this) {}
            return i > -1;            
        };
}

// Funci√≥n para detectar soporte de caracter√≠sticas
const supports = {
    grid: window.CSS && CSS.supports && CSS.supports('display', 'grid'),
    flexbox: window.CSS && CSS.supports && CSS.supports('display', 'flex'),
    contentEditable: 'contentEditable' in document.documentElement,
    fileReader: typeof FileReader !== 'undefined',
    localStorage: (function() {
        try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
        } catch(e) {
            return false;
        }
    })()
};

// Mostrar advertencias si faltan caracter√≠sticas importantes
window.addEventListener('DOMContentLoaded', function() {
    if (!supports.localStorage) {
        showToast('‚ö†Ô∏è Tu navegador no soporta almacenamiento local. Los datos no se guardar√°n.', 'error');
    }
    
    if (!supports.fileReader) {
        showToast('‚ö†Ô∏è Tu navegador no soporta la carga de im√°genes.', 'error');
    }

    if (!supports.contentEditable) {
        showToast('‚ö†Ô∏è Tu navegador no soporta edici√≥n de texto enriquecido.', 'error');
    }
});

// Funci√≥n mejorada para manejar eventos
function addEvent(element, event, handler) {
    if (element.addEventListener) {
        element.addEventListener(event, handler, false);
    } else if (element.attachEvent) {
        element.attachEvent('on' + event, handler);
    } else {
        element['on' + event] = handler;
    }
}

// Funci√≥n mejorada para manipular clases
function toggleClass(element, className) {
    if (element.classList) {
        element.classList.toggle(className);
    } else {
        var classes = element.className.split(' ');
        var existingIndex = classes.indexOf(className);

        if (existingIndex >= 0)
            classes.splice(existingIndex, 1);
        else
            classes.push(className);

        element.className = classes.join(' ');
    }
}

let database = JSON.parse(localStorage.getItem('advancedEditorDB') || '[]');
let currentTags = [];
let searchQuery = '';
let editingId = null;

// Funci√≥n para mostrar notificaciones toast
function showToast(message, type = 'info') {
    Toastify({
        text: message,
        duration: 3000,
        gravity: "bottom",
        position: "right",
        className: type,
        stopOnFocus: true,
        style: {
            background: "linear-gradient(to right, var(--primary), var(--secondary))",
            boxShadow: "0 3px 10px rgba(0,0,0,0.1)",
            borderRadius: "8px",
            fontSize: "14px",
            padding: "12px 20px"
        }
    }).showToast();
}

function addTag(tag) {
    const trimmedTag = tag.trim();
    if (trimmedTag && !currentTags.includes(trimmedTag)) {
        currentTags.push(trimmedTag);
        updateTagDisplay();
        showToast('Etiqueta a√±adida', 'success');
    } else {
        showToast('Esta etiqueta ya existe', 'info');
    }
}

function removeTag(tag) {
    currentTags = currentTags.filter(t => t !== tag);
    updateTagDisplay();
    showToast('Etiqueta eliminada', 'info');
}

function updateTagDisplay() {
    const tagsList = document.getElementById('tagsList');
    tagsList.innerHTML = currentTags.map(tag => `
        <div class="tag">
            ${tag}
            <span onclick="removeTag('${tag}')">&times;</span>
        </div>
    `).join('');
}

function formatText(command) {
    document.execCommand(command, false);
    document.getElementById('richTextArea').focus();
}

// Funci√≥n para manejar la subida de im√°genes
function handleImageUpload(file) {
    if (!file) {
        console.error('No se proporcion√≥ ning√∫n archivo');
        return;
    }
    
    console.log('Tipo de archivo:', file.type);
    
    // Validar que sea una imagen o SVG
    if (!file.type.startsWith('image/') && file.type !== 'image/svg+xml') {
        showToast('Por favor, selecciona una imagen v√°lida', 'error');
        return;
    }

    const reader = new FileReader();
    
    reader.onerror = function(error) {
        console.error('Error al leer el archivo:', error);
        showToast('Error al procesar el archivo', 'error');
    };

    reader.onload = function(e) {
        try {
            if (file.type === 'image/svg+xml') {
                console.log('Procesando SVG...');
                const svgContent = e.target.result;
                
                // Crear un contenedor para el SVG
                const container = document.createElement('div');
                container.className = 'entry-image-container';
                container.style.display = 'inline-block';
                
                // Insertar el SVG como HTML
                container.innerHTML = svgContent;
                
                // Asegurarse de que el SVG tenga las clases y estilos correctos
                const svgElement = container.querySelector('svg');
                if (svgElement) {
                    svgElement.className = 'entry-image';
                    svgElement.style.maxWidth = '100%';
                    svgElement.style.height = 'auto';
                    
                    // Insertar el contenedor en el editor
                    const editor = document.getElementById('richTextArea');
                    editor.appendChild(container);
                    console.log('SVG insertado correctamente');
                } else {
                    console.error('No se encontr√≥ el elemento SVG en el contenido');
                    showToast('Error al procesar el SVG', 'error');
                }
            } else {
                console.log('Procesando imagen normal...');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'entry-image';
                img.alt = file.name;
                document.getElementById('richTextArea').appendChild(img);
            }
            showToast('Imagen subida correctamente', 'success');
        } catch (error) {
            console.error('Error al procesar la imagen:', error);
            showToast('Error al procesar la imagen', 'error');
        }
    };

    try {
        if (file.type === 'image/svg+xml') {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    } catch (error) {
        console.error('Error al iniciar la lectura del archivo:', error);
        showToast('Error al leer el archivo', 'error');
    }
}

// Event listener para la subida de im√°genes
document.getElementById('imageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        handleImageUpload(file);
        this.value = ''; // Resetear el input
    }
});

function editEntry(id) {
    // Si ya est√°bamos editando otra entrada, guardamos los cambios
    if (editingId !== null && editingId !== id) {
        saveEntry();
    }

    editingId = id;
    const entry = database.find(e => e.id === id);
    if (!entry) return;

    // Rellenar el formulario con los datos de la entrada
    document.getElementById('entryTitle').value = entry.title;
    document.getElementById('richTextArea').innerHTML = entry.content;
    
    // Actualizar las etiquetas
    currentTags = [...(entry.tags || [])];
    updateTagDisplay();

    // Marcar visualmente la entrada que se est√° editando
    updateUI();

    // Scroll hasta el formulario
    document.querySelector('.editor-container').scrollIntoView({ behavior: 'smooth' });
    openCreateModal();
    document.querySelector('.date-info').textContent = `Creado: ${formatDate(entry.timestamp)}`;
}

function saveEntry() {
    const titleInput = document.getElementById('entryTitle');
    const contentArea = document.getElementById('richTextArea');
    
    const title = titleInput.value.trim();
    const content = contentArea.innerHTML.trim();
    
    if (!title || !content) {
        showToast('Por favor, completa el t√≠tulo y el contenido', 'error');
        return;
    }

    if (editingId !== null) {
        // Modo edici√≥n: actualizar entrada existente
        const entryIndex = database.findIndex(e => e.id === editingId);
        if (entryIndex !== -1) {
            database[entryIndex] = {
                ...database[entryIndex],
                title,
                content,
                tags: currentTags,
                lastModified: new Date().toISOString()
            };
            showToast('‚úÖ Entrada actualizada correctamente');
        }
        editingId = null;
    } else {
        // Modo creaci√≥n: nueva entrada
        const newEntry = {
            id: Date.now(),
            title,
            content,
            tags: currentTags,
            timestamp: new Date().toISOString()
        };
        database.push(newEntry);
        showToast('‚úÖ Nueva entrada creada correctamente');
    }

    // Limpiar el formulario
    titleInput.value = '';
    contentArea.innerHTML = '';
    currentTags = [];
    updateTagDisplay();
    
    // Actualizar localStorage y UI
    localStorage.setItem('advancedEditorDB', JSON.stringify(database));
    updateUI();
    closeModal();
}

function clearEditor() {
    document.getElementById('entryTitle').value = '';
    document.getElementById('richTextArea').innerHTML = '';
    currentTags = [];
    updateTagDisplay();
}

function filterEntries(entries, query) {
    if (!query) return entries;
    
    query = query.toLowerCase();
    return entries.filter(entry => {
        // Buscar en tags
        const hasTags = entry.tags && entry.tags.some(tag => 
            tag.toLowerCase().includes(query)
        );
        
        // Buscar en t√≠tulo
        const hasTitle = entry.title.toLowerCase().includes(query);
        
        // Buscar en contenido (excluyendo HTML tags)
        const plainContent = entry.content.replace(/<[^>]+>/g, '');
        const hasContent = plainContent.toLowerCase().includes(query);
        
        return hasTags || hasTitle || hasContent;
    });
}

function highlightMatches(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function updateUI(filterQuery = searchQuery) {
    const entriesList = document.getElementById('entriesList');
    const jsonOutput = document.getElementById('jsonOutput');
    if (!entriesList) return;

    // Ordenar entradas por fecha, m√°s recientes primero
    const sortedEntries = [...database].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
    );

    // Filtrar entradas
    const filteredEntries = filterEntries(sortedEntries, filterQuery);

    // Mostrar mensaje si no hay resultados
    if (filteredEntries.length === 0 && filterQuery) {
        entriesList.innerHTML = `
            <div class="no-results">
                <p>No se encontraron entradas que coincidan con "${filterQuery}"</p>
                <button onclick="clearSearch()" class="action-button">‚ùå Limpiar b√∫squeda</button>
            </div>
        `;
        return;
    }

    // Actualizar la lista de entradas
    entriesList.innerHTML = filteredEntries.map(entry => `
        <div class="entry-item ${filterQuery ? 'highlight-match' : ''} ${entry.id === editingId ? 'editing' : ''}">
            
            <h3>${filterQuery ? highlightMatches(entry.title, filterQuery) : entry.title}</h3>
            <div class="entry-content">
                ${entry.content}
            </div>
            <div class="entry-tags">
                ${(entry.tags || []).map(tag => `
                    <span class="tag ${filterQuery && tag.toLowerCase().includes(filterQuery.toLowerCase()) ? 'highlight' : ''}">
                        ${filterQuery ? highlightMatches(tag, filterQuery) : tag}
                    </span>
                `).join('')}
            </div>
            <div class="entry-meta">
                <div>üìÖ Creado: ${formatDate(entry.timestamp)}</div>
                ${entry.lastModified ? `
                    <div>üîÑ Modificado: ${formatDate(entry.lastModified)}</div>
                ` : ''}
            </div>
            <div class="entry-actions">
                <button class="edit-btn" onclick="editEntry(${entry.id})" title="Editar entrada">‚úèÔ∏è Editar</button>
                <button class="delete-btn" onclick="deleteEntry(${entry.id})" title="Eliminar entrada">üóë Eliminar</button>
            </div>
        </div>
    `).join('');

    // Actualizar la visualizaci√≥n del JSON
    if (jsonOutput) {
        jsonOutput.textContent = JSON.stringify(database, null, 2);
    }
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.value = '';
    searchQuery = '';
    updateUI();
}

// Event listener para el buscador
document.getElementById('searchInput').addEventListener('input', function(e) {
    searchQuery = e.target.value.trim();
    updateUI();
});

function deleteEntry(id) {
    database = database.filter(entry => entry.id !== id);
    updateUI();
    showToast('Entrada eliminada', 'info');
}

function downloadJSON() {
    const dataStr = JSON.stringify(database, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `editor-database_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showToast('Base de datos exportada correctamente', 'success');
}

function openCreateModal() {
    const modal = document.getElementById('editorModal');
    modal.classList.add('active');
}

function closeModal() {
    const modal = document.getElementById('editorModal');
    modal.classList.remove('active');
    clearEditor();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    return `${day}/${month}`;
}

// Inicializaci√≥n
updateUI();
document.getElementById('richTextArea').addEventListener('paste', function(e) {
    e.preventDefault();
    const text = (e.originalEvent || e).clipboardData.getData('text/plain');
    document.execCommand('insertHTML', false, text);
});
</script>

</body>
</html>